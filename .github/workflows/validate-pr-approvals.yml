name: Validate PR Approvals

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-approvals:
    name: Check Approval Rules
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get PR author and reviewers
        id: pr-info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr ? pr.number : context.payload.review.pull_request.number;
            const prAuthor = pr ? pr.user.login : context.payload.review.pull_request.user.login;
            
            // Get PR details
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Get reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Get approvals (only the latest review from each user)
            const latestReviews = {};
            reviews.forEach(review => {
              if (!latestReviews[review.user.login] || 
                  new Date(review.submitted_at) > new Date(latestReviews[review.user.login].submitted_at)) {
                latestReviews[review.user.login] = review;
              }
            });
            
            const approvals = Object.values(latestReviews)
              .filter(review => review.state === 'APPROVED')
              .map(review => review.user.login);
            
            console.log('PR Author:', prAuthor);
            console.log('Approvals:', approvals);
            
            // Check if author is in amlc-organizers team
            let isAuthorOrganizer = false;
            try {
              await github.rest.teams.getMembershipForUserInOrg({
                org: context.repo.owner,
                team_slug: 'amlc-organizers',
                username: prAuthor
              });
              isAuthorOrganizer = true;
              console.log(`${prAuthor} is in amlc-organizers team`);
            } catch (error) {
              console.log(`${prAuthor} is NOT in amlc-organizers team`);
            }
            
            // Check if author is in amlc-reviewers team
            let isAuthorReviewer = false;
            try {
              await github.rest.teams.getMembershipForUserInOrg({
                org: context.repo.owner,
                team_slug: 'amlc-reviewers',
                username: prAuthor
              });
              isAuthorReviewer = true;
              console.log(`${prAuthor} is in amlc-reviewers team`);
            } catch (error) {
              console.log(`${prAuthor} is NOT in amlc-reviewers team`);
            }
            
            // Validation logic
            let isValid = true;
            let message = '';
            
            if (isAuthorOrganizer) {
              // Organizers can self-approve
              console.log('‚úÖ Author is an organizer - can self-approve');
              message = '‚úÖ Author is an organizer and can self-approve their PR';
              isValid = true;
            } else if (isAuthorReviewer) {
              // Reviewers cannot self-approve
              const hasExternalApproval = approvals.some(approver => approver !== prAuthor);
              
              if (hasExternalApproval) {
                console.log('‚úÖ Reviewer has external approval');
                message = '‚úÖ PR has approval from someone other than the author';
                isValid = true;
              } else if (approvals.includes(prAuthor)) {
                console.log('‚ùå Reviewer trying to self-approve');
                message = '‚ùå Reviewers cannot self-approve. Please get approval from another reviewer or an organizer.';
                isValid = false;
              } else {
                console.log('‚è≥ Waiting for approval');
                message = '‚è≥ Waiting for approval from another reviewer or an organizer';
                isValid = false;
              }
            } else {
              // Not in either team - require external approval
              const hasApproval = approvals.length > 0 && !approvals.includes(prAuthor);
              
              if (hasApproval) {
                console.log('‚úÖ External contributor has approval');
                message = '‚úÖ PR has required approval';
                isValid = true;
              } else {
                console.log('‚è≥ Waiting for approval');
                message = '‚è≥ Waiting for approval from a reviewer or organizer';
                isValid = false;
              }
            }
            
            core.setOutput('is_valid', isValid);
            core.setOutput('message', message);
            core.setOutput('is_organizer', isAuthorOrganizer);
            core.setOutput('is_reviewer', isAuthorReviewer);

      - name: Comment on PR
        if: steps.pr-info.outputs.is_valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request 
              ? context.payload.pull_request.number 
              : context.payload.review.pull_request.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `${{ steps.pr-info.outputs.message }}\n\n**Approval Rules:**\n- üîë **Organizers** can self-approve\n- üë• **Reviewers** need approval from another person\n- üåç **External contributors** need approval from a reviewer or organizer`
            });

      - name: Set status
        if: steps.pr-info.outputs.is_valid == 'false'
        run: |
          echo "${{ steps.pr-info.outputs.message }}"
          exit 1

